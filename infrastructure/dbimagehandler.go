package infrastructure

import (
	_ "database/sql"
	"github.com/jmoiron/sqlx"
	_ "github.com/lib/pq"
	"projectServis/interfaces"
)

const schema = `CREATE TABLE if not exists images (
id    integer PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
link  text NOT NULL,
UNIQUE(image)
)`

const makeunique = `ALTER TABLE images
ADD CONSTRAINT image UNIQUE (image);`

type DbimageConnect struct {
	dbimage *sqlx.DB
}

func NewDbimageConnect(dbimage *sqlx.DB) *DbimageConnect {
	return &DbimageConnect{dbimage: dbimage}
}

func (r DbimageConnect) MakeUniqueImageQuery() error {
	_, err := r.dbimage.Exec(makeunique)
	return err
}

func (r DbimageConnect) HistoryAll() ([]interfaces.Image, error) {
	var images []interfaces.Image

	err := r.dbimage.Select(&images, "select * from images")

	usercaseImages := make([]interfaces.Image, 0, len(images))
	for i := range images {
		usercaseImages = append(usercaseImages, interfaces.Image{Link: images[i].Link})
	}
	return usercaseImages, err
}

func (r DbimageConnect) FindImageId(id int) interfaces.Image {
	temp := interfaces.Image{}
	return temp
}

func (r DbimageConnect) ChangeImageId(id int) {
}

func (r DbimageConnect) SaveImage(image interfaces.Image) error {
	_, err := r.dbimage.Exec("INSERT INTO images (image) VALUES ($1)", image.Link)
	return err
}
